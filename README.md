# Helm Charts to Deploy VOLTHA 2.x

This repository defines [Kubernetes Helm](https://helm.sh/) charts that can be
used to deploy a [VOLTHA](https://www.opennetworking.org/voltha/) instance.
More information and documentation can be found in the 
[voltha docs](https://docs.voltha.org/master/kind-voltha/README.html) which we recommend as the starting point.

## Installing charts

To deploy VOLTHA a [Kubernetes](https://kubernetes.io/) environment is
required. There are many mechanisms to deploy a Kubernetes environment and how
to do so is out of scope for this project. A Simple search on the Internet will
lead to the many possibilities.

In addition to a base Kubernetes in order to pass traffic to an OLT additional
services that are external to VOLTHA are required, such as an OpenFlow
Controller with applications to support authentication (`EAPOL`) and IP address
allocation (`DHCP`) as examplified by the [SEBA
Project](https://www.opennetworking.org/seba/).

## Deploying using kind-voltha

We suggest an automated deployment of VOLTHA by using
[kind-volta](https://docs.voltha.org/master/kind-voltha/README.html?highlight=tracing) as described in the 
[voltha docs](https://docs.voltha.org/master/kind-voltha/README.html). 
Note that `kind-voltha` is a thin wrapper over `helm` chart commands, automating some commands and arguments. 

## Manual Example deployment

The following describes how to deploy VOLTHA manually. 

### Prerequisite Helm Chart Repositories
To use the charts for VOLTHA the following two Helm repositories should be 
added to your helm environment:
```shell
helm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com/
helm repo add stable https://kubernetes-charts.storage.googleapis.com
helm repo update
```

### ONOS Controller 
To use the charts for VOLTHA the following two Helm repositories should be 
added to your helm environment:
```shell
helm repo add onos https://charts.onosproject.org
helm repo update
```

then to install ONOS:
```shell script
helm install --create-namespace --set image.pullPolicy=Always,image.repository=voltha/voltha-onos,image.tag=master,replicas=3,atomix.replicas=3 --set defaults.log_level=DEBUG --namespace default onos onos/onos-classic
```

### Deploy VOLTHA Manually

Clone the [VOLTHA Helm Chart](https://github.com/opencord/voltha-helm-charts)
repository and build the chart dependencies as follows:
```shell
helm repo add onf https://charts.opencord.org
helm repo update
```
If you want to use the charts from the locally dowloaded repo:

```shell
git clone https://github.com/opencord/voltha-helm-charts
cd voltha-helm-charts
helm dependency build ./voltha
```

#### Deploy ETCD Operator
[ETCD Operator](https://github.com/coreos/etcd-operator) defines Kubernetes
resources types that allow you define ETCD clusters using standard Kubernetes
manifests. As the VOLTHA helm charts use these resources types the ETCD
operator must be installed before the VOLTHA helm chart.
```shell
helm install --namespace voltha --name voltha-etcd-operator stable/etcd-operator
```

#### Deploy VOLTHA Core Components
At this point the VOLTHA Helm charts can be used to deploy the VOLTHA core
components:

```shell
helm install --create-namespace --set therecanbeonlyone=true --namespace voltha voltha onf/voltha
```

#### Adapters for OpenOLT and OpenONU
The adapters for the OpenOLT and OpenONU are in separate helm charts. 

To install the OpenOLT adapter use:
```shell
helm install --create-namespace --namespace voltha open-olt onf/voltha-adapter-openolt
```

To install the OpenONU adapter use:
```shell
helm install --create-namespace --namespace voltha open-onu onf/voltha-adapter-openonu
```

### Deploying Tracing PoD
Optionally, a Jaeger tracing stack based all-in-one PoD can be deployed in voltha
setup to collect and analyze execution traces generated by various Voltha containers
for execution time analysis and troubleshooting. Refer to below links for more details
on Open Tracing approach:

[Open Tracing](https://opentracing.io/)
[Jaeger Distributed Tracing Stack](https://www.jaegertracing.io/)

To install the Voltha Tracing PoD use:
```shell
helm install --namespace voltha --name voltha-tracing ./voltha-tracing
```

### Kafka and Etcd

VOLTHA relies on [Kafka](https://kafka.apache.org/) for inter-component
communication and [Etcd](https://coreos.com/etcd/) for persistent storage. By
default the VOLTHA Helm charts will deploy private instances of both Kafka and
Etcd in the same namespace into which VOLTHA is deployed. The settings that
control if private instances of these services are deployed can be overridden
using the `--set` or the `--values` options to the `helm install`. The relevant
property keys are:

- `private_etcd_cluster` - if `true` an instance of `etcd-operator` and an
  `etcd-cluster` will be deployed, else neither will be deployed
- `private_kafka_cluster` - if `true` an instance of Kafka will be deployed,
  else it won't be deployed

#### Using alternate Kafka and Etcd instances

If using alternate instance of Kafka or Etcd values **MUST** be overridden when
deploying VOLTHA so that the VOLTHA components can locate the required
services. These values **MUST** be overridden when installing both the `voltha`
and the `voltha-adapter-simulated` chart. The relevant property keys are:

```shell
services:
  kafka:
    adapter:
      service: voltha-kafka.voltha.svc.cluster.local
      port: 9092
    cluster:
      service: voltha-kafka.voltha.svc.cluster.local
      port: 9092

  etcd:
    service: voltha-etcd-cluster-client.voltha.svc.cluster.local
    port: 2379

  controller:
    service: onos-openflow.default.svc.cluster.local
    port: 6653
```

## Delete VOLTHA charts

To remove the VOLTHA and Simulated Adapter deployments standard Helm commands
can be utilized:

```shell
helm delete --purge voltha voltha-adapter-simulated voltha-adapter-openolt voltha-adapter-openonu voltha-etcd-operator
```

## Known issues

Known VOLTHA issues are tracked in [JIRA](https://jira.opencord.org). Issues
that may specifically be observed, or at the very least were discovered, in
this environment can be found in JIRA via a [JIRA Issue
Search](https://jira.opencord.org/issues/?jql=status%20not%20in%20%28closed%2C%20Done%2CResolved%29%20and%20labels%20in%20%28helm%29%20and%20affectedVersion%20in%20%28%22VOLTHA%20v2.0%22%29).

## Pre-patchset submission Checks

On patchset submission, jobs are run in Jenkins that validate the correctness
of the helm charts.

The code for these jobs can be found in
[helm-repo-tools](http://gerrit.opencord.org/helm-repo-tools)

The two scripts that should be run to test are:

- `helmlint.sh`
- `chart_version_check.sh`
